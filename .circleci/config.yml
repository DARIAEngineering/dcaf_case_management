version: '2'
jobs:
  build:
    working_directory: ~/dcaf_case_management
    docker:
      - image: ruby:2.3
      - image: mongo
    steps:
      # - run: apk update && apk upgrade && apk add --no-cache build-base libxml2-dev libxslt-dev linux-headers bash git openssh nodejs && gem install bundler
      # - run: ln -s `which nodejs` /usr/bin/node
      - checkout
      - run:
          name: Install System Dependencies
          command: apt-get update -qq && apt-get install -y build-essential nodejs
      - run:
          name: Install dependencies
          command: bundle install
      - run:
          name: Run tests
          command: bundle exec rake test TESTOPTS="--ci-dir=$CIRCLE_TEST_REPORTS"
  # machine:
  #   ruby:
  #     version: 2.3.3
  #   services:
  #     - docker

# deployment:
#   staging:
#     branch: master
#     commands:
#       - bundle exec rake assets:clobber assets:precompile
#       - git push git@heroku.com:dcaf-cmapp-staging.git $CIRCLE_SHA1:master
#       - docker build -t colinxfleming/dcaf_case_management . && docker login -e "$DOCKEREMAIL" -u "$DOCKERLOGIN" -p "$DOCKERPASS" && docker push colinxfleming/dcaf_case_management

# test:
#   override:
#     - bundle exec rake test TESTOPTS="--ci-dir=$CIRCLE_TEST_REPORTS":
#         parallel: true
#         files:
#           - test/**/*_test.rb
#   post:
#     - gem install --no-rdoc brakeman; bundle exec brakeman --exit-on-warn .
#     - gem install --no-rdoc ruby_audit; bundle exec ruby-audit check
#     - gem install --no-rdoc bundler-audit; bundle-audit update; bundle-audit check
#     # - rake quality
