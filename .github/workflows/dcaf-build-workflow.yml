name: DCAF Build Pipeline
on: [push]

jobs:
  build:
    runs-on: ubuntu-16.04
    # container: ruby:2.6.5
    name: Build
    steps:
      - uses: actions/checkout@v1
        with:
          fetch-depth: 1
      - name: Cache build
        uses: actions/cache@v1
        id: cache
        with:
          path: .
          key: "{{ runner.os }}-docker-{{ hashFiles(.docker/Dockerfile) }}-{{ hashFiles(Gemfile.lock) }}-{{ hashFiles(package.lock) }}"
      - name: docker-compose build
        if: steps.cache.outputs.cache-hit != 'true'
        run: docker-compose build --no-cache
      - name: docker-compose up
        run: docker-compose up -d
      - name: Run test suite
        run: docker-compose run --rm web rake knapsack:minitest
      - name: Check for security flaws via Brakeman
        run: docker-compose run --rm web brakeman --exit-on-warn .
      - name: Check for CVEs in Ruby via ruby-audit
        run: docker-compose run --rm web ruby-audit check
      - name: Check for CVEs in gems via bundle-audit
        run: docker-compose run --rm web "bundle-audit update; bundle-audit check --ignore CVE-2015-9284"
