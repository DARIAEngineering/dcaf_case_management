sudo: required

dist: trusty

language: ruby

services:
  - docker
  - mongod

rvm:
  - 2.4.3

jobs:
  include:
    - stage: build
      script: true
    - stage: test
      before_install:
        - sudo apt-get update
        - sudo apt-get install chromium-chromedriver
      before_script:
        - "export PATH=$PATH:/usr/lib/chromium-browser/"
        - "export DISPLAY=:99.0"
        - "sh -e /etc/init.d/xvfb start"
      script:
        - bundle show
        - bundle exec rake knapsack:minitest
      env:
        - CI_NODE_TOTAL=2 CI_NODE_INDEX=0
        - CI_NODE_TOTAL=2 CI_NODE_INDEX=1
    - stage: run brakeman pro
      script: 
        - yes | gem install --no-rdoc brakeman-pro --source $BRAKEMAN_PRO_URL
        - bundle exec brakeman --exit-on-warn .
    - stage: prepare assets
      script: bundle exec rake assets:clobber assets:precompile
    - stage: deploy to staging heroku
      script: bundle show
      deploy: &heroku
        provider: heroku
        app: dcaf-cmapp-staging
    - stage: deploy new docker image
      script: 
        - bundle show
        - docker login -u="$DOCKER_USERNAME" -p="$DOCKER_PASSWORD"
        - docker build -t $DOCKER_USERNAME/dcaf_case_management:latest -f .docker/Dockerfile . 
        - docker push $DOCKER_USERNAME/dcaf_case_management

stages:
  - build
  - test
  - name: run brakeman pro
    if: branch = master
  - name: prepare assets
    if: branch = master
  - name: deploy to staging heroku
    if: branch = master
  - name: deploy new docker image
    if: branch = master
 