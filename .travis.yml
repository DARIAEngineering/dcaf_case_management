sudo: required

dist: trusty

language: ruby

cache: bundler

services:
  - docker
  - mongod

rvm:
  - 2.4.3

jobs:
  include:
    - stage: prepare cache
      script: true
    - stage: test
      before_script:
        - sudo apt-get update
        - sudo apt-get install chromium-chromedriver libfontconfig
        - "export PATH=$PATH:/usr/lib/chromium-browser/"
        - "export DISPLAY=:99.0"
        - "sh -e /etc/init.d/xvfb start"
      script:
        - bundle exec rake knapsack:minitest
      env:
        - CI_NODE_TOTAL=2 CI_NODE_INDEX=0
        - CI_NODE_TOTAL=2 CI_NODE_INDEX=1
    - stage: run brakeman pro
      if: branch = master
      script: 
        - gem install --no-rdoc brakeman-pro --source $BRAKEMAN_PRO_URL
        - bundle exec brakeman --exit-on-warn .
    - stage: prepare assets
      if: branch = master
      script: bundle exec rake assets:clobber assets:precompile
    - stage: deploy to staging heroku
      if: branch = master
      deploy: &heroku
        provider: heroku
        app: dcaf-cmapp-staging
    - stage: deploy new docker image
      if: branch = master
      script: 
        - docker login -u="$DOCKER_USERNAME" -p="$DOCKER_PASSWORD"
        - docker build -t $DOCKER_USERNAME/dcaf_case_management:latest -f .docker/Dockerfile . 
        - docker push $DOCKER_USERNAME/dcaf_case_management
 